jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install system deps (ImageMagick, pandoc)
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick pandoc

      - name: Install Jupyter and conversion deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install --user jupyter nbconvert nbformat nbclient ipykernel pillow
          # make sure pip --user bin is available to subsequent steps
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          which jupyter || true
          jupyter --version || true
          jupyter nbconvert --version || true

      - name: Clean Jupyter notebooks
        run: |
          # Remove zero-byte notebooks and invalid JSON notebooks to avoid conversion errors
          if [ -d assets/jupyter ]; then
            echo "Cleaning empty or invalid .ipynb files in assets/jupyter"
            find assets/jupyter -name '*.ipynb' -type f -size 0 -print -delete || true
            for f in assets/jupyter/*.ipynb; do
              [ -e "$f" ] || continue
              # try to parse JSON; if parsing fails, remove the file
              python -c "import json,sys
    try:
        json.load(open(sys.argv[1], encoding='utf-8'))
    except Exception:
        sys.exit(1)" "$f" || rm -f "$f"
                done
              else
                echo "No assets/jupyter directory, skipping notebook cleanup"
              fi

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Prepare bundler
        run: |
          bundle clean --force || true
          bundle config set path 'vendor/bundle'

      - name: Install dependencies
        run: |
          bundle install --jobs 4 --retry 3

      - name: Build with Jekyll
        env:
          JEKYLL_ENV: production
        run: |
          bundle exec jekyll build --trace --baseurl ""

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4