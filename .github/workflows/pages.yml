  - name: Setup Python
    uses: actions/setup-python@v4
    with:
      python-version: "3.x"

  - name: Install system deps (ImageMagick)
    run: |
      sudo apt-get update
      sudo apt-get install -y imagemagick

  - name: Install Jupyter and conversion deps
    run: |
      python -m pip install --upgrade pip
      python -m pip install --user jupyter nbconvert nbformat
      echo "$HOME/.local/bin" >> $GITHUB_PATH

  - name: Setup Ruby
    uses: ruby/setup-ruby@v1
    with:
      ruby-version: '3.2'
      bundler-cache: true

  - name: Prepare bundler
    run: |
      bundle clean --force || true
      bundle config set path 'vendor/bundle'

  - name: Install dependencies
    run: |
      bundle install --jobs 4 --retry 3

  - name: Build with Jekyll
    env:
      JEKYLL_ENV: production
    run: |
      bundle exec jekyll build --trace --baseurl ""

  - name: Upload artifact
    uses: actions/upload-pages-artifact@v3
    with:
      path: ./_site